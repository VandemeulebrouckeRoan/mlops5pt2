name: CI

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        env:
          CR_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Logging in as $env:GITHUB_ACTOR"
          docker login ghcr.io -u $env:GITHUB_ACTOR -p $env:CR_PAT

      - name: Build and tag Docker image
        run: |
          $SHORT_SHA = $env:GITHUB_SHA.Substring(0,7)
          $REPO_LOWER = $env:GITHUB_REPOSITORY.ToLower()
          $IMAGE = "ghcr.io/$REPO_LOWER/hello-world-nginx"
          # Use subexpression $() for safe expansion when concatenating with a colon
          docker build -t "$($IMAGE):$($env:GITHUB_REF_NAME)" -t "$($IMAGE):$($SHORT_SHA)" .

      - name: Push images to GHCR
        run: |
          $SHORT_SHA = $env:GITHUB_SHA.Substring(0,7)
          $REPO_LOWER = $env:GITHUB_REPOSITORY.ToLower()
          $IMAGE = "ghcr.io/$REPO_LOWER/hello-world-nginx"
          # Use subexpression $() for safe expansion when concatenating with a colon
          docker push "$($IMAGE):$($env:GITHUB_REF_NAME)"
          docker push "$($IMAGE):$($SHORT_SHA)"
